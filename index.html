<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat com IA</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;600;700&display=swap">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            overflow: hidden; /* Remover barra de rolagem global */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            background: transparent;
        }

        .chat-container {
            width: 100%;
            max-width: 1000px;
            background-color: #f2f2f2;
            border-radius: 10px;
            box-shadow: 2 2 2px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            height: 100vh; /* Ocupa 90% da altura da tela */
            overflow: hidden; /* Impedir rolagem na própria caixa */
        }

        .messages {
            flex: 1;
            padding: 30px;
            background-color: #f2f2f2;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow-y: auto; /* Somente a área de mensagens terá rolagem */
        }

        .message {
            font-family: 'poppins';
            margin-bottom: 15px;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            max-width: 85%;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-start;
            margin-left: auto;
        }

        .message.bot {
            align-self: flex-start;
        }

        .message p {
            display: inline-block;
            padding: 15px;
            border-radius: 20px;
            background: #d8d8d8;
            color: #333333;
            max-width: calc(100% - 30px);
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .message.bot p {
            background: transparent;
            color: #333333;
        }

        .message.bot .profile-icon {
            width: 24px;
            height: 24px;
            margin-right: 0px;
            margin-top: 40px;
        }
        
        .gradient-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255, 0, 0, 0.5), rgba(0, 255, 0, 0.5), rgba(0, 0, 255, 0.5));
            background-size: 400% 400%;
            animation: gradientAnimation 10s ease infinite;
            pointer-events: none;
            border-radius: 50%;
        }

        /* Animação do gradiente */
        @keyframes gradientAnimation {
            0% {
                background-position: 0% 0%;
            }
            50% {
                background-position: 100% 100%;
            }
            100% {
                background-position: 0% 0%;
            }
        }

        .warning {
            font-family: 'poppins';
            font-size: 12px;
            color: #333;
            text-align: center;
            margin-left: 30px;
            margin-right: 30px;
        }

        .input-area {
            display: flex;
            padding: 0px;
            background-color: #f2f2f2;
            align-items: center;
            border: 3px solid #cccccc;
            border-radius: 50px;
            margin-left: 30px;
            margin-right: 30px;
        }

        .input-area input {
            flex: 1;
            border: none;
            padding: 0px;
            font-family: 'poppins';
            font-size: 16px;
            border-radius: 40px;
            background-color: transparent;
            color: #333333;
            margin-left: 20px;
        }
        
        .input-area input:focus {
            outline: none;
            box-shadow: none; /* Remove qualquer sombra */
            border: none; /* Remove qualquer borda */
        }

        .input-area button {
            border: none;
            background-color: transparent;
            cursor: pointer;
        }

        .input-area button img {
            width: 57px;
            height: 57px;
        }

        a {
            color: #cfe2f3;
            text-decoration: none;
        }

        a:hover {
            color: #cfe2f3;
            text-decoration: underline;
        }

        @media (max-width: 350px) {
            .message p {
                font-size: 12px;
            }

            .message {
                margin-bottom: 10px;
                max-width: 90%;
            }

            .warning {
                font-size: 8px;
                margin: 10px 5px;
            }

            .input-area {
                padding: 0px;
                margin-left: 20px;
                margin-right: 20px;
            }

            .input-area input {
                padding: 0px;
                font-size: 12px;
            }

            .input-area button img {
                width: 40px;
                height: 40px;
            }

            .messages {
                padding: 10px;
            }

            .message.bot .profile-icon {
                width: 20px;
                height: 20px;
                margin-left: 10px;
            }
        }

        /* Estilo para o efeito de digitação */
        .typing-effect {
           font-family: 'poppins';
            white-space: pre-wrap;
        }
    </style>
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
</head>
<body>
    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Pergunte à Laura">
            <button id="sendButton">
                <img src="https://img.icons8.com/ios-glyphs/100/009B54/circled-up-2.png" alt="Enviar">
            </button>
        </div>
        <div><p class="warning">Mensagens geradas por IA, a Laura está em versão beta e pode cometer erros. Por isso, cheque as respostas.</p></div>
    </div>

    <!-- Incluindo a biblioteca Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
    <script type="module">
      document.addEventListener('contextmenu', function(event) {
            event.preventDefault(); // Bloqueia o clique com o botão direito
        });
      
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai"; // Importando o Gemini

        const firebaseConfig = {
            apiKey: "AIzaSyDjU_clmc29YVGdZ48BUE6OSvKq7eieqCs",
            authDomain: "projeto-laura-1.firebaseapp.com",
            projectId: "projeto-laura-1",
            storageBucket: "projeto-laura-1.appspot.com",
            messagingSenderId: "156733486916",
            appId: "1:156733486916:web:9c86c2e1b3693f374f8911"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const learningCollection = collection(db, "perguntas_respostas");

 // Chave da API do OpenWeather
        const apiKey = '36e9f671284b84c9ad03da6ea1665af9';
        // URL para São Luís, MA
        const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=Sao%20Luis,BR&units=metric&appid=36e9f671284b84c9ad03da6ea1665af9&lang=pt_br`;

        // Inicialização do Gemini
        const API_KEY = "AIzaSyCqO3mUBLFH2RwkbfH27tDPccoVbeUp-c8"; // Substitua com sua chave da API do Gemini
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('userInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const inputElement = document.getElementById('userInput');
            const userMessage = inputElement.value.trim();
            if (userMessage === '') return;

            displayMessage(userMessage, 'user');
            inputElement.value = '';

            const response = await getResponse(userMessage);
            displayMessage(response || "Desculpe, não entendi sua pergunta.", 'bot');
            scrollToBottom();
        }

        function displayMessage(message, sender) {
            const messagesElement = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageElement.innerHTML = `
                    <img src="https://img.icons8.com/ios-filled/50/333333/sparkling--v1.png" class="profile-icon">
                    <p class="typing-effect">${formatMessage(message)}</p>
                `;
                messagesElement.appendChild(messageElement);
                scrollToBottom();
                applyTypingEffect(messageElement.querySelector('.typing-effect'));
            } else {
                messageElement.innerHTML = `
                    <p>${formatMessage(message)}</p>
                `;
                messagesElement.appendChild(messageElement);
                scrollToBottom();
            }
        }
        
          function formatMessage(message) {
    // Substitui URLs por links clicáveis
    let formattedMessage = message.replace(/(https?:\/\/[^\s]+)/g, '$1');

    // Substitui **texto** por negrito
    formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '$1');

    // Substitui ##texto por itálico
    formattedMessage = formattedMessage.replace(/##(.*?)/g, '$1');

    return formattedMessage;
}

      function applyTypingEffect(element) {
    const text = element.innerHTML;
    element.innerHTML = '';
    let index = 0;
    
    // Define a velocidade base em milissegundos
    const baseSpeed = 15;
    
    // Ajusta a velocidade com base no comprimento do texto
    const speed = baseSpeed * (text.length / 600);
    
    function type() {
        if (index < text.length) {
            element.innerHTML += text.charAt(index);
            index++;
            setTimeout(type, speed); // Usa a velocidade ajustada
        }
    }
    
    type();
}



        function scrollToBottom() {
            const messagesElement = document.getElementById('messages');
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

     

        // Função para obter a data e hora atual
        function getCurrentDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = now.toLocaleDateString('pt-BR', options);
            const formattedTime = now.toLocaleTimeString('pt-BR');
            return `Hoje é ${formattedDate}, e agora são ${formattedTime}.`;
        }

        // Função para obter feriados nacionais usando a BrasilAPI
        async function getFeriadoAtual() {
            const currentYear = new Date().getFullYear();
            const apiUrl = `https://brasilapi.com.br/api/feriados/v1/${currentYear}`;

            try {
                const response = await fetch(apiUrl);
                const feriados = await response.json();
                const today = new Date().toISOString().split('T')[0]; // Obtém a data no formato YYYY-MM-DD
                const feriadoHoje = feriados.find(feriado => feriado.date === today);

                if (feriadoHoje) {
                    return `Hoje é feriado: ${feriadoHoje.name}`;
                } else {
                    return "Hoje não é feriado.";
                }
            } catch (error) {
                console.error("Erro ao obter feriados:", error);
                return "Não consegui verificar os feriados no momento.";
            }
        }

        async function getResponse(userMessage) {
            // Verifica se o usuário perguntou sobre o horário ou data
            if (/que horas são|qual o horário|que dia é hoje|qual a data de hoje/i.test(userMessage)) {
                return getCurrentDateTime();
            }

            // Verifica se o usuário perguntou sobre feriados
            if (/é feriado|tem feriado hoje|qual o feriado/i.test(userMessage)) {
                return await getFeriadoAtual();
            }

            // Consulta no Firebase ou Gemini
            try {
                const querySnapshot = await getDocs(learningCollection);
                const questions = querySnapshot.docs.map(doc => doc.data());
                const fuse = new Fuse(questions, {
                    keys: ['pergunta'],
                    includeScore: true,
                    threshold: 0.4
                });

                const result = fuse.search(userMessage);
                if (result.length > 0) {
                    return result[0].item.resposta;
                }
            } catch (error) {
                console.error("Erro ao buscar resposta:", error);
            }

            // Se não encontrar resposta no Firebase, consulta o Gemini
            return await getGeminiResponse(userMessage);
        }

        async function getGeminiResponse(userMessage) {
            try {
                const prompt = `Por favor, responda a seguinte pergunta em português, você é feminina então se refira a você sempre no feminino: ${userMessage}`;
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) {
                console.error("Erro ao obter resposta do Gemini:", error);
                return "Desculpe, não consegui obter uma resposta.";
            }
        }
    </script>
</body>
</html>