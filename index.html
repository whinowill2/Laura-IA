<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDL Laura IA</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;600;700&display=swap">
    <link rel="stylesheet" href="./styles.css">
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>
</head>
<body>
    <div class="chat-container">
        <div class="messages" id="messages"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Pergunte à Laura">
            <button id="sendButton">
                <img src="https://img.icons8.com/ios-glyphs/100/009B54/circled-up-2.png" alt="Enviar">
            </button>
        </div>
        <div><p class="warning">Mensagens geradas por IA, a Laura está em versão beta e pode cometer erros. Por isso, cheque as respostas.</p></div>
    </div>

    <!-- Incluindo a biblioteca Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
    <script type="module">
      document.addEventListener('contextmenu', function(event) {
            event.preventDefault(); // Bloqueia o clique com o botão direito
        });
      
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai"; // Importando o Gemini

        const firebaseConfig = {
            apiKey: "AIzaSyDjU_clmc29YVGdZ48BUE6OSvKq7eieqCs",
            authDomain: "projeto-laura-1.firebaseapp.com",
            projectId: "projeto-laura-1",
            storageBucket: "projeto-laura-1.appspot.com",
            messagingSenderId: "156733486916",
            appId: "1:156733486916:web:9c86c2e1b3693f374f8911"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const learningCollection = collection(db, "perguntas_respostas");

 // Chave da API do OpenWeather
        const apiKey = '36e9f671284b84c9ad03da6ea1665af9';
        // URL para São Luís, MA
        const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=Sao%20Luis,BR&units=metric&appid=36e9f671284b84c9ad03da6ea1665af9&lang=pt_br`;

        // Inicialização do Gemini
        const API_KEY = "AIzaSyCqO3mUBLFH2RwkbfH27tDPccoVbeUp-c8"; // Substitua com sua chave da API do Gemini
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('userInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        async function sendMessage() {
            const inputElement = document.getElementById('userInput');
            const userMessage = inputElement.value.trim();
            if (userMessage === '') return;

            displayMessage(userMessage, 'user');
            inputElement.value = '';

            const response = await getResponse(userMessage);
            displayMessage(response || "Desculpe, não entendi sua pergunta.", 'bot');
            scrollToBottom();
        }

        function displayMessage(message, sender) {
            const messagesElement = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageElement.innerHTML = `
                    <img src="https://img.icons8.com/ios-filled/50/333333/sparkling--v1.png" class="profile-icon">
                    <p class="typing-effect">${formatMessage(message)}</p>
                `;
                messagesElement.appendChild(messageElement);
                scrollToBottom();
                applyTypingEffect(messageElement.querySelector('.typing-effect'));
            } else {
                messageElement.innerHTML = `
                    <p>${formatMessage(message)}</p>
                `;
                messagesElement.appendChild(messageElement);
                scrollToBottom();
            }
        }
        
          function formatMessage(message) {
    // Substitui URLs por links clicáveis
    let formattedMessage = message.replace(/(https?:\/\/[^\s]+)/g, '$1');

    // Substitui **texto** por negrito
    formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '$1');

    // Substitui ##texto por itálico
    formattedMessage = formattedMessage.replace(/##(.*?)/g, '$1');

    return formattedMessage;
}

      function applyTypingEffect(element) {
    const text = element.innerHTML;
    element.innerHTML = '';
    let index = 0;
    
    // Define a velocidade base em milissegundos
    const baseSpeed = 15;
    
    // Ajusta a velocidade com base no comprimento do texto
    const speed = baseSpeed * (text.length / 600);
    
    function type() {
        if (index < text.length) {
            element.innerHTML += text.charAt(index);
            index++;
            setTimeout(type, speed); // Usa a velocidade ajustada
        }
    }
    
    type();
}



        function scrollToBottom() {
            const messagesElement = document.getElementById('messages');
            messagesElement.scrollTop = messagesElement.scrollHeight;
        }

     

        // Função para obter a data e hora atual
        function getCurrentDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = now.toLocaleDateString('pt-BR', options);
            const formattedTime = now.toLocaleTimeString('pt-BR');
            return `Hoje é ${formattedDate}, e agora são ${formattedTime}.`;
        }

        // Função para obter feriados nacionais usando a BrasilAPI
        async function getFeriadoAtual() {
            const currentYear = new Date().getFullYear();
            const apiUrl = `https://brasilapi.com.br/api/feriados/v1/${currentYear}`;

            try {
                const response = await fetch(apiUrl);
                const feriados = await response.json();
                const today = new Date().toISOString().split('T')[0]; // Obtém a data no formato YYYY-MM-DD
                const feriadoHoje = feriados.find(feriado => feriado.date === today);

                if (feriadoHoje) {
                    return `Hoje é feriado: ${feriadoHoje.name}`;
                } else {
                    return "Hoje não é feriado.";
                }
            } catch (error) {
                console.error("Erro ao obter feriados:", error);
                return "Não consegui verificar os feriados no momento.";
            }
        }

        async function getResponse(userMessage) {
            // Verifica se o usuário perguntou sobre o horário ou data
            if (/que horas são|qual o horário|que dia é hoje|qual a data de hoje/i.test(userMessage)) {
                return getCurrentDateTime();
            }

            // Verifica se o usuário perguntou sobre feriados
            if (/é feriado|tem feriado hoje|qual o feriado/i.test(userMessage)) {
                return await getFeriadoAtual();
            }

            // Consulta no Firebase ou Gemini
            try {
                const querySnapshot = await getDocs(learningCollection);
                const questions = querySnapshot.docs.map(doc => doc.data());
                const fuse = new Fuse(questions, {
                    keys: ['pergunta'],
                    includeScore: true,
                    threshold: 0.4
                });

                const result = fuse.search(userMessage);
                if (result.length > 0) {
                    return result[0].item.resposta;
                }
            } catch (error) {
                console.error("Erro ao buscar resposta:", error);
            }

            // Se não encontrar resposta no Firebase, consulta o Gemini
            return await getGeminiResponse(userMessage);
        }

        async function getGeminiResponse(userMessage) {
            try {
                const prompt = `Por favor, responda a seguinte pergunta em português, você é feminina então se refira a você sempre no feminino: ${userMessage}`;
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) {
                console.error("Erro ao obter resposta do Gemini:", error);
                return "Desculpe, não consegui obter uma resposta.";
            }
        }
    </script>
</body>
</html>